#!/bin/sh

# Slackware build script for sl.
# This script builds the version of sl maintained by the Debian project.

# Written by V'yacheslav Stetskevych

PRGNAM=sl
VERSION=${VERSION:-3.03}
PATCHLEVEL=${PATCHLEVEL:-16}
SRCVERSION=${SRCVERSION:-3.03.orig}
ARCH=${ARCH:-i486}
BUILD=${BUILD:-1}
TAG=${TAG:-_SBo}

CWD=$(pwd)
TMP=${TMP:-/tmp/SBo}
PKG=$TMP/package-$PRGNAM
OUTPUT=${OUTPUT:-/tmp}

if [ "$ARCH" = "i486" ]; then
  SLKCFLAGS="-O2 -march=i486 -mtune=i686"
  LIBDIRSUFFIX=""
elif [ "$ARCH" = "i686" ]; then
  SLKCFLAGS="-O2 -march=i686 -mtune=i686"
  LIBDIRSUFFIX=""
elif [ "$ARCH" = "x86_64" ]; then
  SLKCFLAGS="-O2 -fPIC"
  LIBDIRSUFFIX="64"
fi

set -e

rm -rf $PKG
mkdir -p $TMP $PKG $OUTPUT
cd $TMP
rm -rf $PRGNAM-$SRCVERSION
tar xvf $CWD/${PRGNAM}_$SRCVERSION.tar.gz
cd $PRGNAM-$SRCVERSION
# We are now in the program directory
# Apply the debian patchset, which creates the "debian" directory
echo "Applying debian patchset..."
zcat $CWD/sl_$VERSION-$PATCHLEVEL.diff.gz | patch -p1
# Apply individual debian patches
echo "Patching project files..."
for file in debian/patches/*.dpatch; do
	patch -p1 < "$file"
done

# Reset permissions
chown -R root:root .
find . \
 \( -perm 777 -o -perm 775 -o -perm 711 -o -perm 555 -o -perm 511 \) \
 -exec chmod 755 {} \; -o \
 \( -perm 666 -o -perm 664 -o -perm 600 -o -perm 444 -o -perm 440 -o -perm 400 \) \
 -exec chmod 644 {} \;

CFLAGS="$SLKCFLAGS" \
CXXFLAGS="$SLKCFLAGS" \
LDFLAGS="-lcurses" \
make

# Manual installation follows...
mkdir -p $PKG/usr/games # binaries
cp -p sl sl-h $PKG/usr/games
( cd $PKG/usr/games; ln -s sl LS; )
mkdir -p $PKG/usr/man # man pages
( cd $PKG/usr/man
  mkdir -p man6 de/man6 de.UTF-8/man6 ja/man6 ja.UTF-8/man6
)
( cd debian/man
  cp -p man6/* $PKG/usr/man/man6/
  cp -p de/* $PKG/usr/man/de/man6/
  cp -p de.UTF-8/* $PKG/usr/man/de.UTF-8/man6/
  cp -p ja/* $PKG/usr/man/ja/man6/
  cp -p ja.UTF-8/* $PKG/usr/man/ja.UTF-8/man6/
)
# End of manual installation

# Strip binaries
( cd $PKG
  find . | xargs file | grep "executable" | grep ELF | cut -f 1 -d : | xargs strip --strip-unneeded 2> /dev/null
)

# Compress man pages
( cd $PKG/usr/man
  find . -type f -exec gzip -9 {} \;
)

# Install documentation
mkdir -p $PKG/usr/doc/$PRGNAM-${VERSION}_$PATCHLEVEL
cp -a debian/README* debian/changelog debian/copyright \
    $PKG/usr/doc/$PRGNAM-${VERSION}_$PATCHLEVEL
cat $CWD/$PRGNAM.SlackBuild > $PKG/usr/doc/$PRGNAM-${VERSION}_$PATCHLEVEL/$PRGNAM.SlackBuild

mkdir -p $PKG/install
cat $CWD/slack-desc > $PKG/install/slack-desc

cd $PKG
/sbin/makepkg -l y -c n $OUTPUT/$PRGNAM-${VERSION}_$PATCHLEVEL-$ARCH-$BUILD$TAG.tgz
